<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è, –°–µ—Ä–≥–µ–π –í–∞–ª–µ–Ω—Ç–∏–Ω–æ–≤–∏—á!</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{--bg1:#667eea;--bg2:#764ba2;--glass:rgba(255,255,255,.95);--accent:#ff6b6b}
  body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow-x:hidden;position:relative}

  #fw-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:999;pointer-events:none}

  .particles{position:fixed;inset:0;pointer-events:none;z-index:1}
  .particle{position:absolute;width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.8);animation:float 15s linear infinite}
  @keyframes float{0%{transform:translateY(100vh) rotate(0);opacity:0}10%,90%{opacity:1}100%{transform:translateY(-100vh) rotate(360deg);opacity:0}}

  .container{position:relative;z-index:10;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
  .birthday-card{
    width:min(640px,100%);background:var(--glass);backdrop-filter:blur(20px);border-radius:24px;padding:22px;
    box-shadow:0 25px 50px rgba(0,0,0,.15),0 0 0 1px rgba(255,255,255,.08);
    transform:translateY(20px);opacity:0;animation:slideUp .8s ease-out .2s forwards;position:relative;overflow:hidden
  }
  @keyframes slideUp{to{transform:translateY(0);opacity:1}}
  .card-decoration{position:absolute;width:160px;height:160px;border-radius:50%;top:-50px;right:-50px;opacity:.08;background:linear-gradient(45deg,#ff6b6b,#ffd93d);animation:pulse 3s ease-in-out infinite}
  .card-decoration:nth-child(2){top:auto;bottom:-40px;left:-40px;right:auto;background:linear-gradient(45deg,#4ecdc4,#44a08d);animation-delay:1s}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

  .main-title{
    font-family:'Dancing Script',cursive;font-size:clamp(2.4rem,6vw,3.8rem);font-weight:700;text-align:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px
  }
  .subtitle{text-align:center;font-size:1.05rem;color:#666;margin-bottom:18px;font-weight:300}

  .avatar-container{display:flex;justify-content:center;margin-bottom:18px}
  .avatar{
    width:160px;height:160px;border-radius:50%;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:3rem;font-weight:800;background:linear-gradient(135deg,var(--bg1),var(--bg2));
    border:6px solid #fff;box-shadow:0 12px 28px rgba(0,0,0,.18);animation:bounce 2s ease-in-out infinite
  }
  .avatar::before{content:"";position:absolute;inset:-50%;background:linear-gradient(45deg,transparent,rgba(255,255,255,.32),transparent);transform:rotate(45deg);animation:shine 3s ease-in-out infinite}
  .avatar .initials{position:relative;z-index:1}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  @keyframes shine{0%{transform:translate(-100%,-100%) rotate(45deg)}50%{transform:translate(100%,100%) rotate(45deg)}100%{transform:translate(-100%,-100%) rotate(45deg)}}

  .typewriter{font-size:1.1rem;font-weight:800;color:var(--accent);text-align:center;margin:10px 0 14px;min-height:56px;display:flex;align-items:center;justify-content:center;padding:0 8px}
  .cursor{display:inline-block;width:2px;background:var(--accent);margin-left:4px;animation:blink 1s infinite}
  @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}

  .wrong{position:relative;color:#d35c5c;text-decoration:line-through;text-decoration-thickness:2px}
  .message{font-size:1.02rem;line-height:1.65;color:#3a3a3a;text-align:center}
  .message p{margin-bottom:10px}
  .signature{text-align:center;font-size:1.08rem;font-weight:700;color:#5263e9;margin-top:16px}

  .fireworks-btn{
    display:block;margin:18px auto 4px;padding:13px 26px;background:linear-gradient(135deg,#ff6b6b,#ffd93d);color:#fff;border:0;border-radius:999px;
    font-size:1rem;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 10px 22px rgba(255,107,107,.3)
  }
  .fireworks-btn:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(255,107,107,.42)}
  .fireworks-btn:active{transform:translateY(0)}

  .emoji-rain{position:fixed;inset:0;pointer-events:none;z-index:5}
  .falling-emoji{position:absolute;font-size:22px;animation:fall 4.8s linear forwards}
  @keyframes fall{from{transform:translateY(-100vh) rotate(0);opacity:1}to{transform:translateY(100vh) rotate(360deg);opacity:0}}

  .sound-toggle{
    position:fixed;right:14px;bottom:14px;z-index:1000;
    background:rgba(0,0,0,.5);backdrop-filter:blur(8px);color:#fff;border:0;border-radius:999px;
    padding:10px 14px;font-weight:700;display:flex;align-items:center;gap:8px;cursor:pointer
  }
  .sound-toggle span{font-size:0.92rem;opacity:.9}
  .sound-toggle .dot{width:8px;height:8px;border-radius:50%;background:#f87171}
  .sound-on .dot{background:#34d399}
</style>
</head>
<body>
  <canvas id="fw-canvas"></canvas>

  <div class="particles" id="particles"></div>
  <div class="emoji-rain" id="emojiRain"></div>

  <div class="container">
    <div class="birthday-card">
      <div class="card-decoration"></div>
      <div class="card-decoration"></div>

      <h1 class="main-title">–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!</h1>
      <p class="subtitle">–°–µ—Ä–≥–µ–π –í–∞–ª–µ–Ω—Ç–∏–Ω–æ–≤–∏—á</p>

      <div class="avatar-container">
        <div class="avatar" id="avatar"><span class="initials">–°–í</span></div>
      </div>

      <div class="typewriter"><span id="typewriter-text"></span><span class="cursor">&nbsp;</span></div>

      <div class="message">
        <p>–ñ–µ–ª–∞–µ–º –º–æ—â–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è, –ª—ë–≥–∫–∏—Ö –ø–æ–±–µ–¥ –∏ —Ä–æ–≤–Ω–æ–≥–æ –æ–≥–Ω—è –≤ –¥–µ–ª–∞—Ö! üî•</p>
        <p>–ü—É—Å—Ç—å –±–∞–Ω—å–∫–∞ –≤—Å–µ–≥–¥–∞ –≤ —Ç–æ–Ω—É—Å–µ, –º–∞–Ω–≥–∞–ª ‚Äî –±–µ–∑ –¥—ã–º–∞ –≤ –≥–ª–∞–∑–∞, –∞ –≤—ã—Ö–æ–¥–Ω—ã–µ ‚Äî —Å–ø–ª–æ—à–Ω—ã–µ ¬´–≤–∞—É-–º–æ–º–µ–Ω—Ç—ã¬ª. ‚ú®</p>
        <p>–ü—É—Å—Ç—å –Ω–æ–≤—ã–π –≥–æ–¥ –∂–∏–∑–Ω–∏ –∫–∞—á–∞–µ—Ç –∫–∞–∫ –ª—é–±–∏–º—ã–π —Ç—Ä–µ–∫: –≥—Ä–æ–º–∫–æ, —á–∏—Å—Ç–æ –∏ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ! –ë–æ–ª—å—à–µ —Å–º–µ—Ö–∞, –≤–∫—É—Å–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á –∏ –ø–æ–≤–æ–¥–æ–≤ –¥–ª—è –≥–æ—Ä–¥–æ—Å—Ç–∏! üéµ</p>
      </div>

      <div class="signature">–° —Ç–µ–ø–ª–æ–º ‚Äî –ê–Ω–∞—Ç–æ–ª–∏–π –∏ –ò—Ä–∏–Ω–∞ ‚ù§Ô∏è</div>

      <button class="fireworks-btn" id="fw-btn">üéÜ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∞–ª—é—Ç!</button>
    </div>
  </div>

  <button id="soundToggle" class="sound-toggle" aria-pressed="false">
    <div class="dot"></div><span>–ó–≤—É–∫: –≤—ã–∫–ª</span>
  </button>

<script>
/* === Background particles & emoji === */
(function(){const w=document.getElementById('particles');for(let i=0;i<48;i++){const d=document.createElement('div');d.className='particle';d.style.left=(Math.random()*100)+'%';d.style.animationDelay=(Math.random()*15)+'s';d.style.animationDuration=(14+Math.random()*10)+'s';w.appendChild(d);}})();
(function(){const e=['üéâ','üéÇ','üéà','üéÅ','‚ú®','üåü','üí´','üéä'],r=document.getElementById('emojiRain');setInterval(()=>{const n=document.createElement('div');n.className='falling-emoji';n.textContent=e[Math.floor(Math.random()*e.length)];n.style.left=(Math.random()*100)+'%';n.style.animationDuration=(3.6+Math.random()*2.2)+'s';r.appendChild(n);setTimeout(()=>n.remove(),5200);},380)})();

/* === Avatar loader === */
(function(){const a=document.getElementById('avatar'),iSpan=a.querySelector('.initials');const c=["./sergey.jpg","./sergey.JPG","./sergey.jpeg","./sergey.JPEG","./sergey.png","./sergey.PNG","./sergey.webp","./sergey.WEBP","sergey.jpg","sergey.JPG","sergey.jpeg","sergey.JPEG","sergey.png","sergey.PNG","sergey.webp","sergey.WEBP","./photo.jpg","./photo.JPG","./photo.jpeg","./photo.JPEG","./photo.png","./photo.PNG","photo.jpg","photo.JPG","./image.jpg","./image.JPG","image.jpg","image.JPG"];let i=0;function next(){if(i>=c.length)return;const img=new Image();img.onload=()=>{iSpan.style.display='none';Object.assign(img.style,{position:'absolute',inset:'0',width:'100%',height:'100%',objectFit:'cover',borderRadius:'50%',zIndex:'0',opacity:'0',transition:'opacity .5s'});a.appendChild(img);requestAnimationFrame(()=>img.style.opacity='1')};img.onerror=()=>{i++;setTimeout(next,10)};img.src=c[i]+"?v="+Date.now()}setTimeout(next,120)})();

/* === Typewriter (tactful) === */
(function(){
  const el=document.getElementById('typewriter-text');
  const lines=[["–ñ–µ–ª–∞–µ–º ","–æ–±—ã—á–Ω–æ–≥–æ","–∫—Ä–µ–ø–∫–æ–≥–æ"," –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–æ–¥—Ä–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—è! üí™"],["–ü—É—Å—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ –±—É–¥—É—Ç ","–æ–±—ã—á–Ω—ã–º–∏","—è—Ä–∫–∏–º–∏"," –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º–∏—Å—è! ‚ú®"],["–ú–∞–Ω–≥–∞–ª ‚Äî ","–¥—ã–º–Ω—ã–π","–±–µ–∑–¥—ã–º–Ω—ã–π",", –∞ –º—è—Å–æ ‚Äî —Å–æ—á–Ω–æ–µ! üçñ"],["–í –¥–µ–ª–∞—Ö ‚Äî ","–ø–∞—É–∑–∞","—É—Å–∫–æ—Ä–µ–Ω–∏–µ"," –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–±–µ–¥—ã! üöÄ"]];
  const typeDelay=70,eraseDelay=45,holdWrong=700,holdLine=1200,gap=260;
  function typeText(t,f){return new Promise(r=>{let i=f??0;function s(){el.textContent=t.slice(0,i+1);i++;(i<t.length)?setTimeout(s,typeDelay):r()}t.length?setTimeout(s,typeDelay):r()})}
  function wrapWrong(p,w){el.innerHTML=`${p}<span class="wrong" id="wrong-span">${w}</span>`}
  function eraseWrong(){return new Promise(r=>{const sp=document.getElementById('wrong-span');if(!sp)return r();(function st(){const t=sp.textContent;if(t.length){sp.textContent=t.slice(0,-1);setTimeout(st,eraseDelay)}else{sp.remove();r()}})()})}
  async function play([pre,wr,rt,post]){el.textContent="";await new Promise(r=>setTimeout(r,gap));await typeText(pre+wr,0);wrapWrong(pre,wr);await new Promise(r=>setTimeout(r,holdWrong));await eraseWrong();await typeText(pre+rt,0);await typeText(pre+rt+post,(pre+rt).length);await new Promise(r=>setTimeout(r,holdLine))}
  (async function loop(){let i=0;while(true){await play(lines[i%lines.length]);i++}})();
})();

/* === WebAudio with stereo & distance === */
const Sound=(function(){let ctx=null,enabled=false,master=1;function ensure(){if(!ctx){const AC=window.AudioContext||window.webkitAudioContext;if(AC)ctx=new AC()}return ctx}function setEnabled(v){enabled=!!v;if(enabled&&ctx?.state==='suspended')ctx.resume()}function now(){return ctx?ctx.currentTime:0}function mkNoise(sec=.6){const b=ctx.createBuffer(1,ctx.sampleRate*sec,ctx.sampleRate);const d=b.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1);return b}function pan(x){const p=ctx.createStereoPanner?ctx.createStereoPanner():ctx.createGain();if(p.pan)p.pan.value=(x*2-1)*0.85;return p}function playLaunch(x){if(!enabled||!ensure())return;const t=now();const n=ctx.createBufferSource();n.buffer=mkNoise(.22);const bp=ctx.createBiquadFilter();bp.type='bandpass';bp.frequency.value=800;bp.Q.value=.6;const g=ctx.createGain();g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(.35*master,t+.02);g.gain.exponentialRampToValueAtTime(.0001,t+.22);const p=pan(x);n.connect(bp).connect(g).connect(p).connect(ctx.destination);n.start(t);n.stop(t+.24)}function playExplosion(x,heightPx,ppm){if(!enabled||!ensure())return;const dist=Math.max(1,((innerHeight-heightPx)/ppm));const delay=Math.min(.7,dist/343);const t=now()+delay;const n=ctx.createBufferSource();n.buffer=mkNoise(.8);const lp=ctx.createBiquadFilter();lp.type='lowpass';lp.frequency.setValueAtTime(2200,t);lp.frequency.exponentialRampToValueAtTime(280,t+.7);const g=ctx.createGain();const base=(.95/Math.sqrt(dist))*master;g.gain.setValueAtTime(.0001,t);g.gain.exponentialRampToValueAtTime(base,t+.02);g.gain.exponentialRampToValueAtTime(.0001,t+.8);const p=pan(x);n.connect(lp).connect(g).connect(p).connect(ctx.destination);n.start(t);n.stop(t+.82);for(let i=0;i<7;i++){const d=.12+Math.random()*.28;const o=ctx.createOscillator();o.type='triangle';o.frequency.setValueAtTime(180+Math.random()*260,t+d);const gg=ctx.createGain();const lv=(.25/Math.sqrt(dist))*(.7+Math.random()*.6)*master;gg.gain.setValueAtTime(.0001,t+d);gg.gain.exponentialRampToValueAtTime(lv,t+d+.01);gg.gain.exponentialRampToValueAtTime(.0001,t+d+.12);const pp=pan(x+(Math.random()-.5)*.25);o.connect(gg).connect(pp).connect(ctx.destination);o.start(t+d);o.stop(t+d+.14)}}return{ensureCtx:ensure,setEnabled,get enabled(){return enabled},playLaunch,playExplosion,setVolume(v){master=v}}})();

/* === Sound toggle === */
(function(){const btn=document.getElementById('soundToggle');function refresh(){btn.classList.toggle('sound-on',Sound.enabled);btn.setAttribute('aria-pressed',Sound.enabled?'true':'false');btn.querySelector('span').textContent='–ó–≤—É–∫: '+(Sound.enabled?'–≤–∫–ª':'–≤—ã–∫–ª')}btn.addEventListener('click',()=>{Sound.ensureCtx();Sound.setEnabled(!Sound.enabled);refresh()});document.addEventListener('pointerdown',()=>{if(!Sound.enabled){Sound.ensureCtx()}},{once:true});refresh()})();

/* === Fireworks v3: ultra-colorful shells === */
(function(){
  const canvas=document.getElementById('fw-canvas');
  const ctx=canvas.getContext('2d',{alpha:true});
  let DPR=1,W=0,H=0;
  function resize(){DPR=Math.min(window.devicePixelRatio||1,2);W=canvas.width=Math.floor(innerWidth*DPR);H=canvas.height=Math.floor(innerHeight*DPR);canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px'}
  resize();addEventListener('resize',resize);

  // Palettes for extra colorfulness
  const PALETTES=[
    [0,30,60,120,180,240,300],               // rainbow
    [330,20,50,200,260],                     // neon party
    [45,55,35,20,10],                        // gold citrus
    [200,210,220,300,310],                   // ice+magenta
    [120,140,60,0,340],                      // spring mix
  ];

  const rockets=[], parts=[], smoke=[];
  let wind=0, windTarget=0, last=performance.now(), fps=60, quality=1;
  const MAX_BASE=1400;
  const GR=.06, PGR=.075, FRI=.985, PFRI=.972;

  const SHELLS=['peony','chrys','willow','palm','ring','strobe','crossette','double','golden'];
  function rand(a,b){return Math.random()*(b-a)+a}
  function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
  function hsv(h,s,v){let f=(n,k=(n+h/60)%6)=>v-v*s*Math.max(Math.min(k,4-k,1),0);return [f(5),f(3),f(1)]}
  function rgbStr([r,g,b],a=1){return `rgba(${Math.floor(r*255)},${Math.floor(g*255)},${Math.floor(b*255)},${a})`}

  function launch(x){
    const xpx=(x ?? rand(W*0.15,W*0.85));
    const hue=rand(0,360);
    const shell=SHELLS[Math.floor(rand(0,SHELLS.length))];
    const pal=PALETTES[Math.floor(rand(0,PALETTES.length))];
    rockets.push({x:xpx,y:H+8,vx:rand(-.9,.9),vy:-rand(6.0,7.8),hue,pal,life:0,trail:[],shell});
    Sound.playLaunch(xpx/W);
  }

  function spawnSmoke(x,y,n=5){for(let i=0;i<n;i++){smoke.push({x,y,vx:rand(-.2,.2)+wind*.4,vy:rand(-.4,.1),a:.35,r:rand(1.2,3.5),g:rand(.96,.985)})}}

  function burst(x,y,hue,shell,pal){
    if(navigator.vibrate){try{navigator.vibrate([12,22,12])}catch(e){}}
    Sound.playExplosion(x/W,(H-y),2.6*DPR);

    const count=Math.round(rand(110,190)*quality);
    const sat=rand(.65,.98), val=rand(.85,1);

    function colorCycle(life){ // –ª—ë–≥–∫–∏–π —Å–¥–≤–∏–≥ –æ—Ç—Ç–µ–Ω–∫–∞ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
      const base=pal[Math.floor(rand(0,pal.length))] ?? hue;
      return (base + life*rand(20,40))%360;
    }

    function addParticle(angle,speed,opts={}){
      const life = rand(0,1);
      const h = opts.h ?? colorCycle(life);
      const s = opts.s ?? sat, v = opts.v ?? val;
      const col = hsv(h,s,v);
      parts.push({
        x,y,vx:Math.cos(angle)*speed + wind*0.35, vy:Math.sin(angle)*speed,
        a:1, size:(opts.size ?? rand(1.1,2.5))*DPR,
        tw: !!opts.tw, star: !!opts.star,
        hueStart: h, hueShift: rand(8,22),
        colBase: col, // store hsv
        trail:[], type: opts.type || 'spark', split:false
      });
    }

    switch(shell){
      case 'peony':
      case 'chrys': {
        const spMul=shell==='chrys'?3.7:3.3;
        for(let i=0;i<count;i++){
          const ang=Math.random()*Math.PI*2, sp=rand(1.2,spMul)*DPR;
          addParticle(ang,sp,{tw:shell==='chrys' && Math.random()<.35, star:Math.random()<.12});
        }
        break;
      }
      case 'willow': {
        for(let i=0;i<count*.9;i++){
          const ang=Math.random()*Math.PI*2, sp=rand(1.0,2.5)*DPR;
          addParticle(ang,sp,{tw:true,size:rand(1.4,2.8),star:Math.random()<.08});
        }
        break;
      }
      case 'palm': {
        const rays=8+Math.floor(Math.random()*6);
        for(let r=0;r<rays;r++){
          const ang=(r/rays)*Math.PI*2 + rand(-.05,.05);
          for(let k=0;k<16;k++) addParticle(ang,rand(1.6,3.9)*DPR,{size:1.25,star:(k%4===0)&&Math.random()<.6});
        }
        break;
      }
      case 'ring': {
        const ringR=rand(2.2,4.0)*DPR;
        for(let i=0;i<count*.85;i++) addParticle(Math.random()*Math.PI*2, ringR, {tw:Math.random()<.2, size:1.2});
        // —Å–µ—Ä–¥—Ü–µ–≤–∏–Ω–∞
        for(let i=0;i<26;i++) addParticle(Math.random()*Math.PI*2, rand(.8,1.8)*DPR,{size:1.0});
        break;
      }
      case 'strobe': {
        for(let i=0;i<count;i++){
          addParticle(Math.random()*Math.PI*2, rand(1.2,3.2)*DPR, {tw:true, star:Math.random()<.18});
        }
        break;
      }
      case 'crossette': {
        for(let i=0;i<count*.75;i++){
          const ang=Math.random()*Math.PI*2, sp=rand(1.4,3.0)*DPR;
          addParticle(ang,sp,{type:'x'});
        }
        break;
      }
      case 'double': { // –¥–≤–æ–π–Ω–æ–π: –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∏ –≤–Ω–µ—à–Ω–∏–π
        for(let i=0;i<count*.55;i++) addParticle(Math.random()*Math.PI*2, rand(1.0,2.1)*DPR,{size:1.1});
        setTimeout(()=>{ // –≤–Ω–µ—à–Ω–µ–µ –∫–æ–ª—å—Ü–æ –ø–æ–∑–∂–µ
          for(let i=0;i<count*.7;i++) addParticle(Math.random()*Math.PI*2, rand(2.2,3.6)*DPR,{tw:Math.random()<.2, star:Math.random()<.12});
        }, 120);
        break;
      }
      case 'golden': { // ¬´–∑–æ–ª–æ—Ç–∞—è –∏–≤–∞¬ª
        for(let i=0;i<count;i++){
          addParticle(Math.random()*Math.PI*2, rand(1.0,2.2)*DPR,{tw:true,size:rand(1.8,3.2), s:.6, v:1, h:hue});
        }
        break;
      }
    }
    spawnSmoke(x,y,8);
  }

  function drawStar(cx,cy,r,alpha,col){
    // –ø—Ä–æ—Å—Ç–∞—è –∑–≤–µ–∑–¥–∞
    ctx.save();
    ctx.translate(cx,cy);
    ctx.beginPath();
    for(let i=0;i<10;i++){
      const ang=i*Math.PI/5;
      const rad = (i%2===0)? r : r*0.45;
      ctx.lineTo(Math.cos(ang)*rad, Math.sin(ang)*rad);
    }
    ctx.closePath();
    ctx.fillStyle = col;
    ctx.globalAlpha = alpha;
    ctx.fill();
    ctx.globalAlpha = 1;
    ctx.restore();
  }

  function step(dt){
    wind += (windTarget - wind) * 0.003*dt;
    if(Math.random()<0.003*dt) windTarget = clamp(windTarget + rand(-0.18,0.18), -0.65, 0.65);

    // –≥—É—Å—Ç—ã–µ —Å–ª–µ–¥—ã
    ctx.globalCompositeOperation='destination-out';
    ctx.fillStyle=`rgba(0,0,0,${innerWidth<480?0.22:0.17})`;
    ctx.fillRect(0,0,W,H);

    ctx.globalCompositeOperation='lighter';

    // —Ä–∞–∫–µ—Ç—ã
    ctx.shadowColor='rgba(255,255,255,.65)'; ctx.shadowBlur=10*DPR;
    for(let i=rockets.length-1;i>=0;i--){
      const r=rockets[i];
      r.vy += GR*DPR; r.x += r.vx + wind*0.18; r.y += r.vy; r.life++;
      r.trail.push([r.x,r.y]); if(r.trail.length>7) r.trail.shift();

      ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,.95)'; ctx.arc(r.x,r.y,1.9*DPR,0,Math.PI*2); ctx.fill();
      // —Ö–≤–æ—Å—Ç
      ctx.strokeStyle='rgba(255,255,255,.28)';
      for(let t=0;t<r.trail.length-1;t++){
        ctx.lineWidth=Math.max(.7*DPR - t*0.12, .25);
        ctx.beginPath(); ctx.moveTo(r.trail[t][0],r.trail[t][1]); ctx.lineTo(r.trail[t+1][0],r.trail[t+1][1]); ctx.stroke();
      }

      if(r.vy>-0.14 || r.life>145){ burst(r.x,r.y,r.hue,r.shell,r.pal); rockets.splice(i,1); }
    }

    // —á–∞—Å—Ç–∏—Ü—ã
    for(let i=parts.length-1;i>=0;i--){
      const p=parts[i];
      p.vx*=PFRI; p.vy = p.vy*PFRI + PGR*DPR; p.vx += wind*0.01;
      p.x += p.vx; p.y += p.vy;
      p.a -= (0.010 + Math.random()*0.012) * (1.1 - 0.2*quality);

      // –º–∞—Ä—à—Ä—É—Ç
      if(Math.random()<0.7){ p.trail.push([p.x,p.y]); if(p.trail.length>6) p.trail.shift(); }

      // crossette split
      if(p.type==='x' && !p.split && Math.random()<0.012){
        p.split=true;
        for(let k=0;k<4;k++){
          parts.push({x:p.x,y:p.y,vx:p.vx+Math.cos(k*Math.PI/2)*1.25,vy:p.vy+Math.sin(k*Math.PI/2)*1.25,a:p.a,size:p.size*0.9,tw:false,star:false,hueStart:p.hueStart,hueShift:p.hueShift,colBase:p.colBase,trail:[],type:'spark'});
        }
      }

      if(p.a>0){
        // –ø–ª–∞–≤–Ω—ã–π —Å–¥–≤–∏–≥ –æ—Ç—Ç–µ–Ω–∫–∞
        const lifeShift = p.hueStart + p.hueShift * (1 - p.a);
        const [rr,gg,bb]=hsv(lifeShift, 0.9, 1.0);
        const col = `rgba(${Math.floor(rr*255)},${Math.floor(gg*255)},${Math.floor(bb*255)},`;
        const alpha = p.tw ? p.a*(0.5+Math.random()*0.6) : p.a;

        // ¬´–±–ª—é–º¬ª
        ctx.shadowBlur = 15*DPR;
        ctx.shadowColor = col + alpha + ')';

        // —Ä–∏—Å—É–µ–º –∑–≤—ë–∑–¥–æ—á–∫—É –∏–ª–∏ –∫—Ä—É–≥
        if(p.star){
          drawStar(p.x,p.y,p.size*2.0, alpha, col + alpha + ')');
        }else{
          ctx.beginPath(); ctx.fillStyle = col + alpha + ')'; ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
        }

        // —Ä–∞–¥—É–∂–Ω—ã–π —Ö–≤–æ—Å—Ç: screen
        ctx.globalCompositeOperation='screen';
        ctx.shadowBlur=0;
        ctx.lineWidth=Math.max(0.5, p.size*0.35);
        ctx.strokeStyle = col + Math.min(alpha*0.7,0.45) + ')';
        if(p.trail.length>1){ ctx.beginPath(); const t0=p.trail[0]; ctx.moveTo(t0[0],t0[1]); for(let t=1;t<p.trail.length;t++) ctx.lineTo(p.trail[t][0],p.trail[t][1]); ctx.stroke(); }
        ctx.globalCompositeOperation='lighter';
      } else { parts.splice(i,1); }
    }

    // –¥—ã–º
    ctx.globalCompositeOperation='source-over'; ctx.shadowBlur=0;
    for(let i=smoke.length-1;i>=0;i--){
      const s=smoke[i]; s.vx += wind*0.002; s.vy*=0.98; s.x+=s.vx; s.y+=s.vy; s.a*=s.g;
      ctx.fillStyle=`rgba(185,185,185,${s.a})`; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*DPR,0,Math.PI*2); ctx.fill();
      if(s.a<0.02) smoke.splice(i,1);
    }

    // –ª–∏–º–∏—Ç
    const MAX=Math.floor(MAX_BASE*quality);
    if(parts.length>MAX) parts.splice(0,parts.length-MAX);
  }

  function loop(ts){
    const dt=Math.min(3,(ts-last)/16.67); fps=1000/Math.max(16.67, ts-last); last=ts;
    const targetQ = fps>55?1: fps>40?0.85: fps>30?0.7:0.55; quality += (targetQ-quality)*0.05;
    step(dt); requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // manual & auto
  document.getElementById('fw-btn').addEventListener('click',()=>{for(let i=0;i<16;i++) setTimeout(()=>launch(), i*100); setTimeout(()=>{for(let i=0;i<12;i++) setTimeout(()=>launch(), i*85)}, 900)});
  function autoWave(d=8000,int=780){const id=setInterval(()=>{const n=innerWidth<480?1:(Math.random()<0.5?1:2);for(let i=0;i<n;i++) setTimeout(()=>launch(), i*140)},int);setTimeout(()=>clearInterval(id),d)}
  setTimeout(()=>{for(let i=0;i<7;i++) setTimeout(()=>launch(), i*120)},1200);
  setTimeout(()=>autoWave(),3200);
  setTimeout(()=>autoWave(),10500);
})();
</script>
</body>
</html>
