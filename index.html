<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è, –°–µ—Ä–≥–µ–π –í–∞–ª–µ–Ω—Ç–∏–Ω–æ–≤–∏—á!</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{--bg1:#667eea;--bg2:#764ba2;--glass:rgba(255,255,255,.95);--accent:#ff6b6b}
  body{min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow-x:hidden;position:relative}

  /* Fireworks canvas (front) */
  #fw-canvas{position:fixed;inset:0;width:100%;height:100%;z-index:999;pointer-events:none}

  /* Background particles */
  .particles{position:fixed;inset:0;pointer-events:none;z-index:1}
  .particle{position:absolute;width:4px;height:4px;border-radius:50%;background:rgba(255,255,255,.8);animation:float 15s linear infinite}
  @keyframes float{0%{transform:translateY(100vh) rotate(0);opacity:0}10%,90%{opacity:1}100%{transform:translateY(-100vh) rotate(360deg);opacity:0}}

  .container{position:relative;z-index:10;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:16px}
  .birthday-card{
    width:min(640px,100%);background:var(--glass);backdrop-filter:blur(20px);border-radius:24px;padding:22px;
    box-shadow:0 25px 50px rgba(0,0,0,.15),0 0 0 1px rgba(255,255,255,.08);
    transform:translateY(20px);opacity:0;animation:slideUp .8s ease-out .2s forwards;position:relative;overflow:hidden
  }
  @keyframes slideUp{to{transform:translateY(0);opacity:1}}
  .card-decoration{position:absolute;width:160px;height:160px;border-radius:50%;top:-50px;right:-50px;opacity:.08;background:linear-gradient(45deg,#ff6b6b,#ffd93d);animation:pulse 3s ease-in-out infinite}
  .card-decoration:nth-child(2){top:auto;bottom:-40px;left:-40px;right:auto;background:linear-gradient(45deg,#4ecdc4,#44a08d);animation-delay:1s}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

  .main-title{
    font-family:'Dancing Script',cursive;font-size:clamp(2.4rem,6vw,3.8rem);font-weight:700;text-align:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px
  }
  .subtitle{text-align:center;font-size:1.05rem;color:#666;margin-bottom:18px;font-weight:300}

  .avatar-container{display:flex;justify-content:center;margin-bottom:18px}
  .avatar{
    width:160px;height:160px;border-radius:50%;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:3rem;font-weight:800;background:linear-gradient(135deg,var(--bg1),var(--bg2));
    border:6px solid #fff;box-shadow:0 12px 28px rgba(0,0,0,.18);animation:bounce 2s ease-in-out infinite
  }
  .avatar::before{content:"";position:absolute;inset:-50%;background:linear-gradient(45deg,transparent,rgba(255,255,255,.32),transparent);transform:rotate(45deg);animation:shine 3s ease-in-out infinite}
  .avatar .initials{position:relative;z-index:1}
  @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  @keyframes shine{0%{transform:translate(-100%,-100%) rotate(45deg)}50%{transform:translate(100%,100%) rotate(45deg)}100%{transform:translate(-100%,-100%) rotate(45deg)}}

  /* Typewriter */
  .typewriter{font-size:1.1rem;font-weight:800;color:var(--accent);text-align:center;margin:10px 0 14px;min-height:56px;display:flex;align-items:center;justify-content:center;padding:0 8px}
  .cursor{display:inline-block;width:2px;background:var(--accent);margin-left:4px;animation:blink 1s infinite}
  @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0}}

  .wrong{position:relative;color:#d35c5c;text-decoration:line-through;text-decoration-thickness:2px}
  .message{font-size:1.02rem;line-height:1.65;color:#3a3a3a;text-align:center}
  .message p{margin-bottom:10px}
  .signature{text-align:center;font-size:1.08rem;font-weight:700;color:#5263e9;margin-top:16px}

  .fireworks-btn{
    display:block;margin:18px auto 4px;padding:13px 26px;background:linear-gradient(135deg,#ff6b6b,#ffd93d);color:#fff;border:0;border-radius:999px;
    font-size:1rem;font-weight:700;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 10px 22px rgba(255,107,107,.3)
  }
  .fireworks-btn:hover{transform:translateY(-2px);box-shadow:0 14px 28px rgba(255,107,107,.42)}
  .fireworks-btn:active{transform:translateY(0)}

  .emoji-rain{position:fixed;inset:0;pointer-events:none;z-index:5}
  .falling-emoji{position:absolute;font-size:22px;animation:fall 4.8s linear forwards}
  @keyframes fall{from{transform:translateY(-100vh) rotate(0);opacity:1}to{transform:translateY(100vh) rotate(360deg);opacity:0}}

  .sound-toggle{
    position:fixed;right:14px;bottom:14px;z-index:1000;
    background:rgba(0,0,0,.5);backdrop-filter:blur(8px);color:#fff;border:0;border-radius:999px;
    padding:10px 14px;font-weight:700;display:flex;align-items:center;gap:8px;cursor:pointer
  }
  .sound-toggle span{font-size:0.92rem;opacity:.9}
  .sound-toggle .dot{width:8px;height:8px;border-radius:50%;background:#f87171}
  .sound-on .dot{background:#34d399}

  @media (max-width:768px){
    .birthday-card{padding:20px}
    .avatar{width:132px;height:132px;font-size:2.5rem}
    .typewriter{font-size:1.02rem;min-height:48px}
    .message{font-size:.98rem}
  }
</style>
</head>
<body>
  <canvas id="fw-canvas"></canvas>

  <div class="particles" id="particles"></div>
  <div class="emoji-rain" id="emojiRain"></div>

  <div class="container">
    <div class="birthday-card">
      <div class="card-decoration"></div>
      <div class="card-decoration"></div>

      <h1 class="main-title">–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!</h1>
      <p class="subtitle">–°–µ—Ä–≥–µ–π –í–∞–ª–µ–Ω—Ç–∏–Ω–æ–≤–∏—á</p>

      <div class="avatar-container">
        <div class="avatar" id="avatar"><span class="initials">–°–í</span></div>
      </div>

      <div class="typewriter"><span id="typewriter-text"></span><span class="cursor">&nbsp;</span></div>

      <div class="message">
        <p>–ñ–µ–ª–∞–µ–º –º–æ—â–Ω–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è, –ª—ë–≥–∫–∏—Ö –ø–æ–±–µ–¥ –∏ —Ä–æ–≤–Ω–æ–≥–æ –æ–≥–Ω—è –≤ –¥–µ–ª–∞—Ö! üî•</p>
        <p>–ü—É—Å—Ç—å –±–∞–Ω—å–∫–∞ –≤—Å–µ–≥–¥–∞ –≤ —Ç–æ–Ω—É—Å–µ, –º–∞–Ω–≥–∞–ª ‚Äî –±–µ–∑ –¥—ã–º–∞ –≤ –≥–ª–∞–∑–∞, –∞ –≤—ã—Ö–æ–¥–Ω—ã–µ ‚Äî —Å–ø–ª–æ—à–Ω—ã–µ ¬´–≤–∞—É-–º–æ–º–µ–Ω—Ç—ã¬ª. ‚ú®</p>
        <p>–ü—É—Å—Ç—å –Ω–æ–≤—ã–π –≥–æ–¥ –∂–∏–∑–Ω–∏ –∫–∞—á–∞–µ—Ç –∫–∞–∫ –ª—é–±–∏–º—ã–π —Ç—Ä–µ–∫: –≥—Ä–æ–º–∫–æ, —á–∏—Å—Ç–æ –∏ –Ω–∞ –ø–æ–≤—Ç–æ—Ä–µ! –ë–æ–ª—å—à–µ —Å–º–µ—Ö–∞, –≤–∫—É—Å–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á –∏ –ø–æ–≤–æ–¥–æ–≤ –¥–ª—è –≥–æ—Ä–¥–æ—Å—Ç–∏! üéµ</p>
      </div>

      <div class="signature">–° —Ç–µ–ø–ª–æ–º ‚Äî –ê–Ω–∞—Ç–æ–ª–∏–π –∏ –ò—Ä–∏–Ω–∞ ‚ù§Ô∏è</div>

      <button class="fireworks-btn" id="fw-btn">üéÜ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∞–ª—é—Ç!</button>
    </div>
  </div>

  <button id="soundToggle" class="sound-toggle" aria-pressed="false">
    <div class="dot"></div><span>–ó–≤—É–∫: –≤—ã–∫–ª</span>
  </button>

<script>
/* ===== Background particles ===== */
(function(){
  const wrap = document.getElementById('particles');
  for(let i=0;i<48;i++){
    const d=document.createElement('div');
    d.className='particle';
    d.style.left = (Math.random()*100)+'%';
    d.style.animationDelay = (Math.random()*15)+'s';
    d.style.animationDuration = (14+Math.random()*10)+'s';
    wrap.appendChild(d);
  }
})();

/* ===== Emoji rain ===== */
(function(){
  const emojis = ['üéâ','üéÇ','üéà','üéÅ','‚ú®','üåü','üí´','üéä'];
  const rain = document.getElementById('emojiRain');
  function drop(){
    const e=document.createElement('div');
    e.className='falling-emoji';
    e.textContent = emojis[Math.floor(Math.random()*emojis.length)];
    e.style.left = (Math.random()*100)+'%';
    e.style.animationDuration = (3.6+Math.random()*2.2)+'s';
    rain.appendChild(e);
    setTimeout(()=>e.remove(), 5200);
  }
  setInterval(drop, 380);
})();

/* ===== Avatar loader ===== */
(function(){
  const avatar = document.getElementById('avatar');
  const initials = avatar.querySelector('.initials');
  const candidates = [
    "./sergey.jpg","./sergey.JPG","./sergey.jpeg","./sergey.JPEG",
    "./sergey.png","./sergey.PNG","./sergey.webp","./sergey.WEBP",
    "sergey.jpg","sergey.JPG","sergey.jpeg","sergey.JPEG",
    "sergey.png","sergey.PNG","sergey.webp","sergey.WEBP",
    "./photo.jpg","./photo.JPG","./photo.jpeg","./photo.JPEG",
    "./photo.png","./photo.PNG","photo.jpg","photo.JPG",
    "./image.jpg","./image.JPG","image.jpg","image.JPG"
  ];
  let i=0;
  function next(){
    if(i>=candidates.length) return;
    const img = new Image();
    img.onload = () =>{
      initials.style.display='none';
      Object.assign(img.style,{position:'absolute',inset:'0',width:'100%',height:'100%',objectFit:'cover',borderRadius:'50%',zIndex:'0',opacity:'0',transition:'opacity .5s'});
      avatar.appendChild(img);
      requestAnimationFrame(()=>img.style.opacity='1');
    };
    img.onerror = ()=>{ i++; setTimeout(next,10); };
    img.src = candidates[i] + "?v=" + Date.now();
  }
  setTimeout(next,120);
})();

/* ===== Typewriter (tactful gag) ===== */
(function(){
  const el = document.getElementById('typewriter-text');
  const lines = [
    ["–ñ–µ–ª–∞–µ–º ", "–æ–±—ã—á–Ω–æ–≥–æ", "–∫—Ä–µ–ø–∫–æ–≥–æ", " –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–æ–¥—Ä–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ—è! üí™"],
    ["–ü—É—Å—Ç—å –≤—ã—Ö–æ–¥–Ω—ã–µ –±—É–¥—É—Ç ", "–æ–±—ã—á–Ω—ã–º–∏", "—è—Ä–∫–∏–º–∏", " –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—â–∏–º–∏—Å—è! ‚ú®"],
    ["–ú–∞–Ω–≥–∞–ª ‚Äî ", "–¥—ã–º–Ω—ã–π", "–±–µ–∑–¥—ã–º–Ω—ã–π", ", –∞ –º—è—Å–æ ‚Äî —Å–æ—á–Ω–æ–µ! üçñ"],
    ["–í –¥–µ–ª–∞—Ö ‚Äî ", "–ø–∞—É–∑–∞", "—É—Å–∫–æ—Ä–µ–Ω–∏–µ", " –∏ —É–≤–µ—Ä–µ–Ω–Ω—ã–µ –ø–æ–±–µ–¥—ã! üöÄ"]
  ];
  const typeDelay=70, eraseDelay=45, holdWrong=700, holdLine=1200, gap=260;

  function typeText(text, fromLen){
    return new Promise(res=>{
      let i=fromLen??0;
      function step(){
        el.textContent = text.slice(0,i+1);
        i++; (i<text.length)?setTimeout(step,typeDelay):res();
      }
      text.length?setTimeout(step,typeDelay):res();
    });
  }
  function typePlain(str){ return typeText(str,0); }
  function wrapWrong(prefix, wrong){ el.innerHTML = `${prefix}<span class="wrong" id="wrong-span">${wrong}</span>`; }
  function eraseWrongLetters(){
    return new Promise(res=>{
      const span = document.getElementById('wrong-span'); if(!span) return res();
      (function step(){ const t=span.textContent; if(t.length){ span.textContent=t.slice(0,-1); setTimeout(step,eraseDelay);} else { span.remove(); res(); } })();
    });
  }
  async function playLine([pre, wrong, right, post]){
    el.textContent=""; await new Promise(r=>setTimeout(r,gap));
    await typePlain(pre+wrong); wrapWrong(pre, wrong); await new Promise(r=>setTimeout(r,holdWrong));
    await eraseWrongLetters(); await typePlain(pre+right);
    await typeText(pre+right+post,(pre+right).length); await new Promise(r=>setTimeout(r,holdLine));
  }
  (async function loop(){ let i=0; while(true){ await playLine(lines[i%lines.length]); i++; }})();
})();

/* ===== WebAudio with stereo & distance ===== */
const Sound = (function(){
  let ctx=null, enabled=false;
  function ensureCtx(){ if(!ctx){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) ctx=new AC(); } return ctx; }
  function setEnabled(v){ enabled=!!v; if(enabled && ctx?.state==='suspended') ctx.resume(); }
  function now(){ return ctx?ctx.currentTime:0; }

  function mkNoiseBuffer(sec=0.6){
    const buf = ctx.createBuffer(1, ctx.sampleRate*sec, ctx.sampleRate);
    const d = buf.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1);
    return buf;
  }

  function panNode(xNorm){ // xNorm: 0..1
    const p = ctx.createStereoPanner ? ctx.createStereoPanner() : null;
    if(p){ p.pan.value = (xNorm*2-1)*0.8; return p; }
    // fallback: just return gain
    return ctx.createGain();
  }

  function playLaunch(xNorm){
    if(!enabled || !ensureCtx()) return;
    const t=now();
    const noise = ctx.createBufferSource(); noise.buffer = mkNoiseBuffer(0.22);
    const bp = ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=800; bp.Q.value=0.6;
    const g=ctx.createGain(); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(0.35,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.22);
    const p = panNode(xNorm);
    noise.connect(bp).connect(g).connect(p).connect(ctx.destination);
    noise.start(t); noise.stop(t+0.24);
  }

  function playExplosion(xNorm, heightPx, pxPerMeter){
    if(!enabled || !ensureCtx()) return;
    const distanceM = Math.max(1, ( (innerHeight - heightPx)/pxPerMeter )); // –Ω–∏–∂–µ ‚Äî –±–ª–∏–∂–µ
    const delay = Math.min(0.7, distanceM/343); // —Å–∫–æ—Ä–æ—Å—Ç—å –∑–≤—É–∫–∞ ~343 –º/—Å
    const t = now() + delay;

    const noise = ctx.createBufferSource(); noise.buffer = mkNoiseBuffer(0.7);
    const lp = ctx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(2000,t); lp.frequency.exponentialRampToValueAtTime(250,t+0.6);
    const g=ctx.createGain(); const base=0.9/Math.sqrt(distanceM); g.gain.setValueAtTime(0.0001,t); g.gain.exponentialRampToValueAtTime(base,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.7);
    const p = panNode(xNorm);
    noise.connect(lp).connect(g).connect(p).connect(ctx.destination);
    noise.start(t); noise.stop(t+0.72);

    // crackles
    for(let i=0;i<6;i++){
      const d=0.1+Math.random()*0.25;
      const osc=ctx.createOscillator(); osc.type='triangle'; osc.frequency.setValueAtTime(180+Math.random()*240,t+d);
      const gg=ctx.createGain(); const lv = (0.25/Math.sqrt(distanceM))*(0.7+Math.random()*0.6); gg.gain.setValueAtTime(0.0001,t+d); gg.gain.exponentialRampToValueAtTime(lv,t+d+0.01); gg.gain.exponentialRampToValueAtTime(0.0001,t+d+0.12);
      const pp = panNode(xNorm+(Math.random()-.5)*0.2);
      osc.connect(gg).connect(pp).connect(ctx.destination);
      osc.start(t+d); osc.stop(t+d+0.14);
    }
  }

  return { ensureCtx, setEnabled, get enabled(){return enabled}, playLaunch, playExplosion };
})();

/* ===== Sound toggle UI ===== */
(function(){
  const btn = document.getElementById('soundToggle');
  function refresh(){
    btn.classList.toggle('sound-on', Sound.enabled);
    btn.setAttribute('aria-pressed', Sound.enabled ? 'true':'false');
    btn.querySelector('span').textContent = '–ó–≤—É–∫: ' + (Sound.enabled ? '–≤–∫–ª' : '–≤—ã–∫–ª');
  }
  btn.addEventListener('click', ()=>{ Sound.ensureCtx(); Sound.setEnabled(!Sound.enabled); refresh(); });
  document.addEventListener('pointerdown', ()=>{ if(!Sound.enabled){ Sound.ensureCtx(); } }, {once:true});
  refresh();
})();

/* ===== Fireworks v2: shells, smoke, wind, trails, adaptive ===== */
(function(){
  const canvas = document.getElementById('fw-canvas');
  const ctx = canvas.getContext('2d', { alpha:true });

  let DPR=1, W=0, H=0;
  function resize(){
    DPR = Math.min(window.devicePixelRatio||1, 2);
    W = canvas.width = Math.floor(innerWidth*DPR);
    H = canvas.height = Math.floor(innerHeight*DPR);
    canvas.style.width = innerWidth+'px'; canvas.style.height = innerHeight+'px';
  }
  resize(); addEventListener('resize', resize);

  // Globals
  const rockets=[], parts=[], smoke=[];
  let wind = 0, windTarget = 0, lastT = performance.now(), fps=60, quality=1;
  const MAX_PARTS_BASE = 1000; // adaptive with quality
  const GR = 0.06, PGR = 0.075, FRI=0.985, PFRI=0.972;

  function rand(a,b){return Math.random()*(b-a)+a}
  function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
  const hsv = (h,s,v)=>{ let f=(n,k=(n+h/60)%6)=>v - v*s*Math.max(Math.min(k,4-k,1),0); return [f(5),f(3),f(1)].map(x=>Math.floor(x*255)); };

  // Shell types
  const SHELLS = ['peony','chrys','willow','palm','ring','strobe','crossette'];

  function launch(x){
    const xpx = (x ?? rand(W*0.2, W*0.8));
    const hue = rand(0,360);
    const shell = SHELLS[Math.floor(rand(0,SHELLS.length))];
    rockets.push({
      x:xpx, y:H+8, vx: rand(-0.9,0.9), vy: -rand(6.0, 7.6),
      hue, life:0, trail:[], shell
    });
    Sound.playLaunch(xpx/W);
  }

  function spawnSmoke(x,y,amount=4){
    for(let i=0;i<amount;i++){
      smoke.push({
        x,y, vx: rand(-0.2,0.2)+wind*0.4, vy: rand(-0.4,0.1),
        a: 0.35, r: rand(1.2, 3.5), g: rand(0.96,0.985)
      });
    }
  }

  function burst(x,y,hue,shell){
    // Haptics
    if(navigator.vibrate){ try{ navigator.vibrate([15, 25, 15]); }catch(e){} }
    // Sound
    Sound.playExplosion(x/W, (H - y), 2.5 * DPR); // pxPerMeter ~2.5*DPR (–ø—Ä–∏–º–µ—Ä–Ω–∞—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∞)

    const count = Math.round(rand(100, 160) * quality);
    const sat = rand(0.55,0.95), val = rand(0.85,1);
    function makeParticle(angle, speed, tw=false, sizeScale=1){
      const [r,g,b]=hsv(hue+rand(-10,10), sat, val);
      parts.push({
        x, y,
        vx: Math.cos(angle)*speed + wind*0.4,
        vy: Math.sin(angle)*speed,
        a: 1, size: rand(1.1,2.4)*DPR*sizeScale,
        col:`rgba(${r},${g},${b},`, tw, trail:[], type:'spark', split:false
      });
    }

    switch(shell){
      case 'peony':
      case 'chrys': {
        const spMul = shell==='chrys'? 3.6 : 3.2;
        for(let i=0;i<count;i++){
          const ang = Math.random()*Math.PI*2;
          const sp = rand(1.2, spMul)*DPR;
          const tw = (shell==='chrys') ? Math.random()<0.3 : Math.random()<0.15;
          makeParticle(ang, sp, tw);
        }
        break;
      }
      case 'willow': {
        for(let i=0;i<count*0.85;i++){
          const ang = Math.random()*Math.PI*2;
          const sp = rand(1.0, 2.4)*DPR;
          makeParticle(ang, sp, true, 1.2);
        }
        break;
      }
      case 'palm': {
        const rays = 8+Math.floor(Math.random()*6);
        for(let r=0;r<rays;r++){
          const ang = (r/rays)*Math.PI*2 + rand(-0.05,0.05);
          for(let k=0;k<14;k++){
            makeParticle(ang, rand(1.4, 3.8)*DPR, false, 1.1);
          }
        }
        break;
      }
      case 'ring': {
        const ringR = rand(2.2,3.8)*DPR;
        for(let i=0;i<count*0.8;i++){
          const ang = Math.random()*Math.PI*2;
          makeParticle(ang, ringR, Math.random()<0.15, 1.1);
        }
        break;
      }
      case 'strobe': {
        for(let i=0;i<count;i++){
          const ang = Math.random()*Math.PI*2;
          const sp = rand(1.2,3.2)*DPR;
          const pTw = true;
          makeParticle(ang, sp, pTw);
        }
        break;
      }
      case 'crossette': {
        for(let i=0;i<count*0.7;i++){
          const ang = Math.random()*Math.PI*2;
          const sp = rand(1.4,3.0)*DPR;
          const p = {x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,a:1,size:rand(1.2,2.2)*DPR,col:'',tw:false,trail:[],type:'x',split:false,hue};
          const [r,g,b]=hsv(hue+rand(-8,8), sat, val);
          p.col=`rgba(${r},${g},${b},`; parts.push(p);
        }
        break;
      }
    }
    spawnSmoke(x,y, 8);
  }

  // Draw helpers
  function drawTrail(tr){
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    for(let t=0;t<tr.length-1;t++){
      ctx.lineWidth = Math.max(0.6*DPR - t*0.12, 0.2);
      ctx.beginPath(); ctx.moveTo(tr[t][0], tr[t][1]); ctx.lineTo(tr[t+1][0], tr[t+1][1]); ctx.stroke();
    }
  }

  function step(dt){
    // wind drift
    wind += (windTarget - wind) * 0.003*dt;
    if(Math.random()<0.003*dt) windTarget = clamp(windTarget + rand(-0.15,0.15), -0.6, 0.6);

    // fade canvas for trails
    ctx.globalCompositeOperation='destination-out';
    ctx.fillStyle = `rgba(0,0,0,${innerWidth<480?0.22:0.18})`;
    ctx.fillRect(0,0,W,H);
    ctx.globalCompositeOperation='lighter';

    // rockets
    ctx.shadowColor='rgba(255,255,255,0.6)'; ctx.shadowBlur = 8*DPR;
    for(let i=rockets.length-1;i>=0;i--){
      const r = rockets[i];
      r.vy += GR*DPR; r.x += r.vx + wind*0.2; r.y += r.vy; r.life++;
      r.trail.push([r.x,r.y]); if(r.trail.length>6) r.trail.shift();

      // core
      ctx.beginPath(); ctx.fillStyle='rgba(255,255,255,.95)'; ctx.arc(r.x,r.y,1.9*DPR,0,Math.PI*2); ctx.fill();
      drawTrail(r.trail);

      if(r.vy > -0.15 || r.life>140){
        burst(r.x,r.y,r.hue,r.shell);
        rockets.splice(i,1);
      }
    }

    // particles
    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      // physics
      p.vx *= PFRI; p.vy = p.vy*PFRI + PGR*DPR; p.vx += wind*0.01;
      p.x += p.vx; p.y += p.vy;
      p.a -= (0.010 + Math.random()*0.012) * (1.1 - 0.2*quality);

      // crossette split
      if(p.type==='x' && !p.split && Math.random()<0.01){
        p.split=true;
        for(let k=0;k<4;k++){
          parts.push({x:p.x,y:p.y,vx:p.vx+Math.cos(k*Math.PI/2)*1.2,vy:p.vy+Math.sin(k*Math.PI/2)*1.2,a:p.a,size:p.size*0.9,col:p.col,tw:false,trail:[],type:'spark'});
        }
      }

      // trail memory
      if(Math.random()<0.6){ p.trail.push([p.x,p.y]); if(p.trail.length>5) p.trail.shift(); }

      // draw spark
      if(p.a>0){
        const alpha = p.tw ? p.a*(0.5+Math.random()*0.6) : p.a;
        ctx.shadowColor = p.col.replace('rgba','rgba').replace(',','').replace(')', '') + alpha + ')';
        ctx.shadowBlur = 14*DPR;
        ctx.fillStyle = p.col + alpha + ')';
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();

        // faint trail
        ctx.shadowBlur = 0;
        ctx.globalCompositeOperation='screen';
        ctx.strokeStyle = p.col + Math.min(alpha*0.6,0.35) + ')';
        ctx.lineWidth = Math.max(0.5, p.size*0.35);
        if(p.trail.length>1){ ctx.beginPath(); const t0=p.trail[0]; ctx.moveTo(t0[0],t0[1]); for(let t=1;t<p.trail.length;t++) ctx.lineTo(p.trail[t][0],p.trail[t][1]); ctx.stroke(); }
        ctx.globalCompositeOperation='lighter';
      } else { parts.splice(i,1); }
    }

    // smoke layer (under additive)
    ctx.globalCompositeOperation='source-over';
    ctx.shadowBlur=0;
    for(let i=smoke.length-1;i>=0;i--){
      const s = smoke[i];
      s.vx += wind*0.002; s.vy *= 0.98; s.x += s.vx; s.y += s.vy;
      s.a *= s.g;
      ctx.fillStyle = `rgba(180,180,180,${s.a})`;
      ctx.beginPath(); ctx.arc(s.x, s.y, s.r*DPR, 0, Math.PI*2); ctx.fill();
      if(s.a<0.02) smoke.splice(i,1);
    }

    // adaptive cap
    const MAX_PARTS = Math.floor(MAX_PARTS_BASE * quality);
    if(parts.length>MAX_PARTS) parts.splice(0, parts.length - MAX_PARTS);
  }

  // main loop with dt
  function loop(ts){
    const dt = Math.min(3, (ts - lastT)/16.67); // normalize to ~60fps
    fps = 1000 / Math.max(16.67, ts - lastT);
    lastT = ts;

    // adjust quality
    const targetQ = fps>55 ? 1 : fps>40 ? 0.85 : fps>30 ? 0.7 : 0.55;
    quality += (targetQ - quality) * 0.05;

    step(dt);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // manual button
  document.getElementById('fw-btn').addEventListener('click', ()=>{
    for(let i=0;i<14;i++) setTimeout(()=>launch(), i*110);
    setTimeout(()=>{for(let i=0;i<10;i++) setTimeout(()=>launch(), i*90);}, 900);
  });

  // auto waves
  function autoWave(duration=8000, interval=850){
    const id = setInterval(()=>{
      const n = innerWidth<480?1:(Math.random()<0.5?1:2);
      for(let i=0;i<n;i++) setTimeout(()=>launch(), i*140);
    }, interval);
    setTimeout(()=>clearInterval(id), duration);
  }
  setTimeout(()=>{ for(let i=0;i<6;i++) setTimeout(()=>launch(), i*120); }, 1200);
  setTimeout(()=>autoWave(), 3200);
  setTimeout(()=>autoWave(), 10500);
})();
</script>
</body>
</html>
